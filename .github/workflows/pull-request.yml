name: CI - Pull Request

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write  # Allows pushing commits back to repo

jobs:
  # Step 1: Run linter (fast feedback)
  linter:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if only export files changed
        id: check_exports
        run: |
          # Get list of changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if all changes are in .kobweb-export/
          if [ -z "$CHANGED_FILES" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
          elif echo "$CHANGED_FILES" | grep -v '^\.kobweb-export/' > /dev/null; then
            # Found files outside .kobweb-export/
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Found code changes, will run linter"
          else
            # All changes are in .kobweb-export/
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Only export files changed, skipping linter"
          fi

      - name: Set up JDK 21
        if: steps.check_exports.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Cache Gradle packages
        if: steps.check_exports.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        if: steps.check_exports.outputs.skip != 'true'
        run: chmod +x ./gradlew

      - name: Run Kotlin Linter
        if: steps.check_exports.outputs.skip != 'true'
        run: ./gradlew detektJsMain

      - name: Lint skipped (export-only changes)
        if: steps.check_exports.outputs.skip == 'true'
        run: echo "✓ Linting skipped - only .kobweb-export/ files changed"

  # Step 2: Build (validates it compiles)
  build:
    name: Build Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if only export files changed
        id: check_exports
        run: |
          # Get list of changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if all changes are in .kobweb-export/
          if [ -z "$CHANGED_FILES" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
          elif echo "$CHANGED_FILES" | grep -v '^\.kobweb-export/' > /dev/null; then
            # Found files outside .kobweb-export/
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Found code changes, will run build"
          else
            # All changes are in .kobweb-export/
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Only export files changed, skipping build"
          fi

      - name: Set up JDK 21
        if: steps.check_exports.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Cache Gradle packages
        if: steps.check_exports.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        if: steps.check_exports.outputs.skip != 'true'
        run: chmod +x ./gradlew

      - name: Run Builder
        if: steps.check_exports.outputs.skip != 'true'
        run: ./gradlew assemble

      - name: Build skipped (export-only changes)
        if: steps.check_exports.outputs.skip == 'true'
        run: echo "✓ Build skipped - only .kobweb-export/ files changed"


  # Optional: Uncomment when you're ready to add tests
  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #   needs: linter
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up JDK 21
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: "21"
  #         distribution: "temurin"
  #     - name: Cache Gradle packages
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           ~/.gradle/caches
  #           ~/.gradle/wrapper
  #         key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
  #         restore-keys: |
  #           ${{ runner.os }}-gradle-
  #     - name: Make gradlew executable
  #       run: chmod +x ./gradlew
  #     - name: Run Unit Tests
  #       run: ./gradlew allTests
