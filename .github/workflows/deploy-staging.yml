name: Manual Deploy - Staging

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch, tag, or commit SHA) to deploy'
        required: true
        default: 'main'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  export-staging:
    name: Export Staging Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code at specified ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright Chromium
        run: |
          npm init -y
          npx playwright install --with-deps chromium

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Download Kobweb CLI
        run: |
          KOBWEB_VERSION=0.9.18
          wget https://github.com/varabyte/kobweb-cli/releases/download/v${KOBWEB_VERSION}/kobweb-${KOBWEB_VERSION}.zip
          unzip kobweb-${KOBWEB_VERSION}.zip
          echo "${PWD}/kobweb-${KOBWEB_VERSION}/bin" >> $GITHUB_PATH

      - name: Configure Gradle for limited resources
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.jvmargs=-Xmx2g" >> ~/.gradle/gradle.properties
          echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties

      - name: Export Kobweb site for Staging
        working-directory: ./site
        env:
          BASE_URL: https://stag.cb-connect-it.com
        run: |
          echo "Exporting STAGING build from ref: ${{ inputs.ref }}"
          echo "BASE_URL: ${BASE_URL}"
          kobweb export --notty
          
          # Verify export was successful
          echo ""
          echo "Export completed. Verifying structure..."
          if [ -f ".kobweb/server/start.sh" ]; then
            echo "âœ“ start.sh found"
          else
            echo "âœ— start.sh NOT found!"
            ls -laR .kobweb/
            exit 1
          fi

      - name: Organize export
        run: |
          EXPORT_DIR=.kobweb-export/staging
          mkdir -p ${EXPORT_DIR}
          cp -r site/.kobweb ${EXPORT_DIR}/
          
          # Verify the directory structure is correct
          if [ ! -f "${EXPORT_DIR}/.kobweb/server/start.sh" ]; then
            echo "ERROR: Directory structure is incorrect!"
            echo "Expected: ${EXPORT_DIR}/.kobweb/server/start.sh"
            echo "Actual contents:"
            ls -laR ${EXPORT_DIR}
            exit 1
          fi
          
          # Create a manifest file with build info
          cat > ${EXPORT_DIR}/BUILD_INFO.txt << EOF
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Environment: staging
          Base URL: https://stag.cb-connect-it.com
          Git Ref: ${{ inputs.ref }}
          Git Commit: ${GITHUB_SHA}
          Workflow Run: ${GITHUB_RUN_NUMBER}
          Triggered By: ${{ github.actor }}
          Linter: Passed âœ“
          Build: Passed âœ“
          Export Path: .kobweb/server/start.sh verified âœ“
          EOF
          
          echo "âœ“ Export structure verified successfully"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "ðŸŸ¡ deploy(staging): update Kobweb export for staging environment"
          branch: deploy/staging-${{ github.run_number }}
          delete-branch: true
          title: "ðŸŸ¡ Deploy Staging Export from ${{ inputs.ref }}"
          body: |
            ## Staging Deployment
            
            This PR contains the staging export build.
            
            **Source Ref:** `${{ inputs.ref }}`
            **Commit:** `${{ github.sha }}`
            **Triggered by:** @${{ github.actor }}
            **Workflow Run:** #${{ github.run_number }}
            
            ### Build Information
            - Environment: **staging**
            - Base URL: https://stag.cb-connect-it.com
            - Build Date: ${{ github.run_started_at }}
            
            ### What's Changed
            - Updated `.kobweb-export/staging/` with new build
            
            ### âœ… Automated Checks
            This is an automated export PR. The required checks will:
            1. Detect that only `.kobweb-export/staging/` changed
            2. Skip linting and building (already done in this workflow)
            3. Complete successfully in ~10 seconds
            
            **This PR will auto-merge once all checks pass.**
            
            ---
            *This PR was automatically generated by the Manual Deploy - Staging workflow*
          labels: |
            deployment
            staging
            automated-export
          add-paths: |
            .kobweb-export/staging/**

      - name: Enable Pull Request Auto-Merge
        if: steps.create-pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Enabling auto-merge for PR #${{ steps.create-pr.outputs.pull-request-number }}"
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --auto --squash --delete-branch
